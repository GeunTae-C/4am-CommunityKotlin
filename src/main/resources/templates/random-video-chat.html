<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>랜덤 화상채팅</title>
    <link rel="stylesheet" href="/css/VChat-style.css">
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
</head>
<body>
<div>
    <div class="video-container">
        <div class="video-inner-container">
            <video id="localVideo" autoplay playsinline></video>
            <div class="vc-user-profile">
                <svg width="480" height="480"  viewBox="0 0 480 480" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M316.4 277.2C293.696 292.076 267.143 300.001 240 300.001C212.857 300.001 186.304 292.076 163.6 277.2C134.324 290.964 109.298 312.363 91.1551 339.146C73.012 365.929 62.4223 397.107 60.5 429.4C60.4117 430.769 60.6059 432.141 61.0704 433.431C61.5349 434.721 62.2597 435.902 63.2 436.9C64.141 437.887 65.2741 438.672 66.5295 439.205C67.7849 439.738 69.1361 440.009 70.5 440H410C411.364 440.009 412.715 439.738 413.97 439.205C415.226 438.672 416.359 437.887 417.3 436.9C418.24 435.902 418.965 434.721 419.43 433.431C419.894 432.141 420.088 430.769 420 429.4C418.031 397.055 407.366 365.841 389.132 339.052C370.898 312.264 345.77 290.895 316.4 277.2Z" fill="#DBDFE8"/>
                    <path d="M240 280C306.274 280 360 226.274 360 160C360 93.7258 306.274 40 240 40C173.726 40 120 93.7258 120 160C120 226.274 173.726 280 240 280Z" fill="#DBDFE8"/>
                </svg>
            </div>
        </div>
        <div class="video-inner-container">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="vc-user-profile">
                <svg width="480" height="480"  viewBox="0 0 480 480" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <<path d="M316.4 277.2C293.696 292.076 267.143 300.001 240 300.001C212.857 300.001 186.304 292.076 163.6 277.2C134.324 290.964 109.298 312.363 91.1551 339.146C73.012 365.929 62.4223 397.107 60.5 429.4C60.4117 430.769 60.6059 432.141 61.0704 433.431C61.5349 434.721 62.2597 435.902 63.2 436.9C64.141 437.887 65.2741 438.672 66.5295 439.205C67.7849 439.738 69.1361 440.009 70.5 440H410C411.364 440.009 412.715 439.738 413.97 439.205C415.226 438.672 416.359 437.887 417.3 436.9C418.24 435.902 418.965 434.721 419.43 433.431C419.894 432.141 420.088 430.769 420 429.4C418.031 397.055 407.366 365.841 389.132 339.052C370.898 312.264 345.77 290.895 316.4 277.2Z" fill="#DBDFE8"/>
                    <path d="M240 280C306.274 280 360 226.274 360 160C360 93.7258 306.274 40 240 40C173.726 40 120 93.7258 120 160C120 226.274 173.726 280 240 280Z" fill="#DBDFE8"/>
                </svg>
            </div>
        </div>
    </div>

    <div class="video-controls-wrapper" style="display: none;">
        <div class="local-controls">
            <button id="toggleMic">
                <!-- 마이크 아이콘 (기본 상태) -->
                <svg id="micIcon" width="24" height="24" viewBox="0 0 24 24">
                    <!-- 마이크 아이콘 SVG 코드 -->
                    <path d="M12 14a3 3 0 003-3V5a3 3 0 00-6 0v6a3 3 0 003 3z"></path>
                    <path d="M19 11a1 1 0 00-1-1h-2a1 1 0 000 2h2a1 1 0 001-1z"></path>
                </svg>
                <span>마이크 끄기</span>
            </button>
            <button id="toggleVideo">
                <!-- 카메라 아이콘 (기본 상태) -->
                <svg id="videoIcon" width="24" height="24" viewBox="0 0 24 24">
                    <!-- 카메라 아이콘 SVG 코드 -->
                    <path d="M17 10.5V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4.5l4 4v-13l-4 4z"></path>
                </svg>
                <span>카메라 끄기</span>
            </button>
        </div>

        <div class="remote-controls">
            <button id="toggleRemoteAudio">
                <!-- 상대방 소리 아이콘 (기본 상태) -->
                <svg id="remoteAudioIcon" width="24" height="24" viewBox="0 0 24 24">
                    <!-- 소리 아이콘 SVG 코드 -->
                    <path d="M3 9v6h4l5 5V4L7 9H3z"></path>
                </svg>
                <span>상대방 소리 끄기</span>
            </button>
            <input type="range" id="remoteVolume" min="0" max="1" step="0.01" value="1">
            <button id="toggleRemoteVideo">
                <!-- 상대방 화면 아이콘 (기본 상태) -->
                <svg id="remoteVideoIcon" width="24" height="24" viewBox="0 0 24 24">
                    <!-- 화면 끄기 아이콘 SVG 코드 -->
                    <path d="M17 10.5V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4.5l4 4v-13l-4 4z"></path>
                </svg>
                <span>상대방 화면 끄기</span>
            </button>
        </div>
    </div>

    <div class="controls-chat-wrapper">
        <div class="control-container">

            <div id="mainButtonBox">
                <div id="returnHome" onclick="location.href='/'">
                    <svg width="100" height="100" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M40.348 23.4008L25.348 12.4918C25.1772 12.367 24.9711 12.2998 24.7595 12.2998C24.548 12.2998 24.3419 12.367 24.171 12.4918L9.17102 23.4008C9.06485 23.4781 8.97494 23.5755 8.90642 23.6875C8.8379 23.7996 8.79212 23.924 8.7717 24.0537C8.75127 24.1834 8.75659 24.3159 8.78736 24.4436C8.81813 24.5713 8.87374 24.6916 8.95102 24.7978C9.02831 24.904 9.12575 24.9939 9.23778 25.0624C9.34981 25.1309 9.47424 25.1767 9.60396 25.1971C9.86595 25.2384 10.1336 25.1739 10.348 25.0178L12.322 23.5818V37.2998C12.322 37.565 12.4274 37.8194 12.6149 38.0069C12.8025 38.1944 13.0568 38.2998 13.322 38.2998H21.397C21.6622 38.2998 21.9166 38.1944 22.1041 38.0069C22.2917 37.8194 22.397 37.565 22.397 37.2998V27.9068H27.122V37.2998C27.122 37.565 27.2274 37.8194 27.4149 38.0069C27.6025 38.1944 27.8568 38.2998 28.122 38.2998H36.197C36.4622 38.2998 36.7166 38.1944 36.9041 38.0069C37.0917 37.8194 37.197 37.565 37.197 37.2998V23.5828L39.171 25.0188C39.2772 25.0963 39.3976 25.152 39.5253 25.1829C39.6531 25.2137 39.7856 25.219 39.9154 25.1985C40.0452 25.1779 40.1697 25.132 40.2817 25.0632C40.3937 24.9945 40.491 24.9042 40.568 24.7978C40.6453 24.6916 40.7009 24.5713 40.7317 24.4436C40.7625 24.3159 40.7678 24.1834 40.7474 24.0537C40.7269 23.924 40.6811 23.7996 40.6126 23.6875C40.5441 23.5755 40.4542 23.4781 40.348 23.4008ZM35.197 36.3008H29.122V26.9078C29.122 26.6426 29.0167 26.3882 28.8291 26.2007C28.6416 26.0131 28.3872 25.9078 28.122 25.9078H21.397C21.1318 25.9078 20.8775 26.0131 20.6899 26.2007C20.5024 26.3882 20.397 26.6426 20.397 26.9078V36.3008H14.322V22.1278L24.76 14.5368L35.198 22.1278V36.3008H35.197Z" fill="black"/>
                    </svg>
                    <div id="returnHomeText">홈페이지</div>
                </div>

                <div id="startRandomChat">
                    <svg width="30" height="30" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M29.924 25.3299C29.924 25.8899 30.374 26.3299 30.924 26.3299C32.064 26.3299 32.984 27.2599 32.984 28.3899C32.984 28.9399 33.434 29.3899 33.984 29.3899C34.534 29.3899 34.984 28.9399 34.984 28.3899C34.984 26.1499 33.164 24.3299 30.924 24.3299C30.374 24.3299 29.924 24.7799 29.924 25.3299ZM46.2039 29.3899C46.7639 29.3899 47.2039 28.9399 47.2039 28.3899C47.2039 19.4099 39.9039 12.1099 30.924 12.1099C30.374 12.1099 29.924 12.5599 29.924 13.1099C29.924 13.6599 30.374 14.1099 30.924 14.1099C38.804 14.1099 45.2039 20.5199 45.2039 28.3899C45.2039 28.9399 45.6539 29.3899 46.2039 29.3899Z" fill="#212121"/>
                        <path d="M39.094 28.39C39.094 28.94 39.544 29.39 40.094 29.39C40.644 29.39 41.094 28.94 41.094 28.39C41.094 22.78 36.534 18.22 30.924 18.22C30.374 18.22 29.924 18.67 29.924 19.22C29.924 19.78 30.374 20.22 30.924 20.22C35.434 20.22 39.094 23.89 39.094 28.39ZM30.924 6C30.374 6 29.924 6.45 29.924 7C29.924 7.55 30.374 8 30.924 8C42.174 8 51.324 17.15 51.324 28.39C51.324 28.94 51.764 29.39 52.324 29.39C52.874 29.39 53.324 28.94 53.324 28.39C53.324 16.04 43.274 6 30.924 6ZM40.694 38.93L39.384 39.64C37.174 40.85 34.374 40.44 32.584 38.65L22.024 28.09C20.234 26.3 19.824 23.5 21.034 21.28L21.744 19.98C22.544 18.5 22.834 16.84 22.594 15.18C22.3673 13.5234 21.6012 11.9875 20.414 10.81C18.954 9.35 17.014 8.55 14.944 8.55C12.874 8.55 10.924 9.35 9.46402 10.81L8.95402 11.33C6.25402 14.03 5.94402 18.68 8.07402 24.44C10.084 29.94 14.134 35.9 19.454 41.22C27.564 49.33 36.594 54 43.074 54C45.634 54 47.804 53.27 49.344 51.73L49.864 51.21C50.5841 50.4907 51.1553 49.6364 51.5448 48.6961C51.9343 47.7557 52.1345 46.7478 52.134 45.73C52.12 43.6803 51.3054 41.7173 49.864 40.26C47.454 37.85 43.684 37.31 40.694 38.93Z" fill="#212121"/>
                    </svg>
                    <span>랜덤 채팅 시작</span>
                </div>
                <div id="loadingMessage" style="display: none;">
                    <div id="loadingMessageText">상대를 검색중입니다...</div>
                    <div class="loader"></div> <!-- 로딩 아이콘 -->
                </div>
                <div id="chatControls" style="display: none;">
                    <div id="disconnectChatBox">
                        <svg width="60" height="60" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="20" fill="#FF5656"/>
                            <g clip-path="url(#clip0_150_330)">
                                <path d="M7.1508 24.1218C6.58649 23.5549 6.24296 22.8052 6.18198 22.0076L5.98389 19.5186C5.89968 18.5005 6.12371 17.4807 6.62683 16.5916C7.12996 15.7025 7.88892 14.9854 8.80505 14.5334C12.2743 12.807 16.0951 11.9042 19.9702 11.8955C23.8452 11.9039 27.6661 12.8064 31.1355 14.5325C32.0487 14.988 32.8052 15.7058 33.3079 16.5939C33.8106 17.4821 34.0366 18.5001 33.957 19.5175L33.7591 22.0065C33.7255 22.4553 33.6018 22.8928 33.3952 23.2926C33.1887 23.6925 32.9036 24.0466 32.557 24.3338C32.2105 24.6209 31.8096 24.8353 31.3783 24.9639C30.947 25.0926 30.4942 25.1329 30.047 25.0826L26.2144 24.6585C25.5994 24.5901 25.0206 24.3333 24.5573 23.9232C24.094 23.5131 23.7688 22.9697 23.6263 22.3676L23.1383 20.324C23.0852 20.1056 22.96 19.9114 22.7829 19.7729C22.6059 19.6343 22.3873 19.5595 22.1625 19.5604L17.7784 19.5606C17.5536 19.5597 17.335 19.6345 17.158 19.7731C16.981 19.9117 16.8558 20.1058 16.8027 20.3243L16.3148 22.3679C16.1741 22.9689 15.8502 23.5115 15.3879 23.9206C14.9256 24.3298 14.3477 24.5853 13.734 24.6519L9.89442 25.0834C9.39423 25.1397 8.88778 25.0825 8.41276 24.9161C7.93774 24.7496 7.50638 24.4781 7.1508 24.1218Z" fill="white"/>
                            </g>
                            <defs>
                                <clipPath id="clip0_150_330">
                                    <rect width="24" height="24" fill="white" transform="translate(36.9412 19.9697) rotate(134.998)"/>
                                </clipPath>
                            </defs>
                        </svg>
                        <div id="disconnectChat">통화 끊기</div>
                    </div>

                    <div id="findAnotherBox">
                        <svg id="findAnotherIcon" width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g clip-path="url(#clip0_151_346)">
                                <path d="M36 71.9782C28.3517 71.9726 20.9033 69.5349 14.7316 65.0173L14.6239 67.5277C14.6219 67.6767 14.5895 67.8238 14.5285 67.9598C14.4676 68.0958 14.3794 68.2179 14.2695 68.3186C14.1596 68.4192 14.0302 68.4963 13.8894 68.5451C13.7485 68.5938 13.5992 68.6133 13.4505 68.6021C13.3029 68.5956 13.1581 68.5601 13.0242 68.4977C12.8903 68.4352 12.7701 68.3469 12.6703 68.238C12.5705 68.129 12.4932 68.0015 12.4427 67.8626C12.3922 67.7238 12.3696 67.5764 12.3761 67.4288L12.5782 62.7376C12.5873 62.5282 12.6546 62.3254 12.7728 62.1522C12.8909 61.9791 13.055 61.8423 13.2467 61.7574C13.4384 61.6726 13.65 61.6429 13.8576 61.6719C14.0652 61.7009 14.2606 61.7873 14.4217 61.9213C20.8877 67.3128 29.1362 70.0912 37.5464 69.7107C45.9566 69.3301 53.9204 65.8181 59.873 59.8647C65.8256 53.9113 69.3365 45.947 69.7159 37.5367C70.0953 29.1265 67.3158 20.8784 61.9234 14.4132C61.8286 14.2998 61.7571 14.1688 61.7129 14.0278C61.6688 13.8867 61.6528 13.7384 61.6659 13.5912C61.6791 13.444 61.7211 13.3008 61.7896 13.1698C61.8581 13.0388 61.9517 12.9226 62.0651 12.8279C62.1785 12.7331 62.3095 12.6615 62.4505 12.6174C62.5916 12.5732 62.7399 12.5572 62.8872 12.5704C63.0344 12.5835 63.1775 12.6256 63.3085 12.6941C63.4395 12.7626 63.5557 12.8562 63.6505 12.9696C68.0328 18.2222 70.8263 24.6157 71.7033 31.4C72.5803 38.1842 71.5044 45.0779 68.6018 51.2723C65.6992 57.4667 61.0904 62.7048 55.3159 66.3723C49.5414 70.0398 42.8407 71.9845 36 71.9782Z" fill="#42B168"/>
                                <path d="M13.7011 63.9109C13.4236 63.9107 13.1559 63.8079 12.9495 63.6222C12.7432 63.4365 12.6127 63.1812 12.5833 62.9051C12.5539 62.6291 12.6275 62.352 12.79 62.127C12.9526 61.902 13.1925 61.745 13.4638 61.6862L17.7617 60.7535C17.9063 60.7216 18.0558 60.7187 18.2015 60.7447C18.3473 60.7708 18.4865 60.8253 18.6111 60.9053C18.7357 60.9852 18.8434 61.089 18.9278 61.2106C19.0123 61.3322 19.0719 61.4693 19.1033 61.614C19.1346 61.7588 19.1371 61.9082 19.1106 62.0539C19.0841 62.1996 19.0291 62.3386 18.9488 62.463C18.8684 62.5874 18.7643 62.6947 18.6425 62.7787C18.5206 62.8628 18.3833 62.922 18.2385 62.9529L13.9406 63.8857C13.8619 63.9027 13.7816 63.9112 13.7011 63.9109ZM9.21432 59.434C9.04947 59.4342 8.88659 59.3982 8.73719 59.3285C8.58778 59.2589 8.45551 59.1572 8.3497 59.0308C2.72731 52.2804 -0.231188 43.7063 0.0320371 34.9251C0.295262 26.144 3.76202 17.7624 9.77865 11.361C15.7953 4.95951 23.946 0.980421 32.6941 0.173966C41.4421 -0.63249 50.183 1.78942 57.2685 6.98304L57.3762 4.4727C57.3798 4.32416 57.4133 4.17788 57.4748 4.04263C57.5363 3.90737 57.6245 3.78593 57.7341 3.68559C57.8437 3.58525 57.9724 3.50807 58.1125 3.45869C58.2527 3.40932 58.4013 3.38875 58.5496 3.39824C58.6972 3.40473 58.8421 3.44023 58.9759 3.50272C59.1098 3.5652 59.2301 3.65344 59.3298 3.7624C59.4296 3.87135 59.5069 3.9989 59.5574 4.13774C59.6079 4.27659 59.6305 4.42402 59.624 4.57161L59.4218 9.26274C59.4128 9.47217 59.3454 9.67491 59.2273 9.8481C59.1092 10.0213 58.9451 10.158 58.7534 10.2429C58.5617 10.3278 58.3501 10.3574 58.1425 10.3284C57.9349 10.2995 57.7395 10.2131 57.5783 10.079C51.1124 4.68758 42.8639 1.90917 34.4537 2.28974C26.0436 2.67032 18.0797 6.18236 12.1272 12.1358C6.17459 18.0891 2.66365 26.0534 2.28424 34.4637C1.90483 42.8739 4.68438 51.122 10.0767 57.5872C10.214 57.7513 10.3017 57.9512 10.3294 58.1633C10.3571 58.3755 10.3237 58.5912 10.2332 58.7851C10.1427 58.9789 9.99872 59.143 9.81825 59.2579C9.63777 59.3728 9.42829 59.4339 9.21432 59.434Z" fill="#42B168"/>
                                <path d="M43.6399 39.7202C41.3696 41.2078 38.7143 42.0003 35.9999 42.0003C33.2856 42.0003 30.6303 41.2078 28.3599 39.7202C25.4323 41.0966 22.9297 43.2365 21.1154 45.9148C19.3011 48.5931 18.2422 51.7109 18.0499 54.9402C18.0411 55.0771 18.0605 55.2143 18.107 55.3433C18.1534 55.4723 18.2259 55.5904 18.3199 55.6902C18.414 55.7889 18.5273 55.8674 18.6529 55.9207C18.7784 55.974 18.9135 56.0011 19.0499 56.0002H52.9999C53.1363 56.0011 53.2714 55.974 53.397 55.9207C53.5225 55.8674 53.6358 55.7889 53.7299 55.6902C53.8239 55.5904 53.8964 55.4723 53.9429 55.3433C53.9893 55.2143 54.0087 55.0771 53.9999 54.9402C53.803 51.7057 52.7366 48.5842 50.9131 45.9054C49.0897 43.2266 46.5769 41.0897 43.6399 39.7202Z" fill="#54DF92"/>
                                <path d="M36 40C42.6274 40 48 34.6274 48 28C48 21.3726 42.6274 16 36 16C29.3726 16 24 21.3726 24 28C24 34.6274 29.3726 40 36 40Z" fill="#54DF92"/>
                            </g>
                            <defs>
                                <clipPath id="clip0_151_346">
                                    <rect width="72" height="72" fill="white"/>
                                </clipPath>
                            </defs>
                        </svg>
                        <div id="findAnother">다른 상대 찾기</div>
                    </div>
                </div>
            </div>

        </div>

        <div class="chat-container">
            <div id="chatBox"></div>
            <div id="chatSendBox">
                <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
                <button id="sendMessage">전송</button>
            </div>
        </div>
    </div>
</div>
    <script>
        const accessToken = localStorage.getItem('access_token');

        let signalingServer;
        let localStream;
        let remoteStream;
        let peerConnection;
        let pendingCandidates = [];
        let offerQueue = [];  // Offer를 대기시키는 큐
        let role = null;

        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            const chatControlBox = document.getElementById('chatControls');
            const disconnectButton = document.getElementById('disconnectChatBox');
            const findAnotherButton = document.getElementById('findAnotherBox');
            const startRandomChatButton = document.getElementById('startRandomChat');
            const loadingMessage = document.getElementById('loadingMessage');
            const vcUserProfiles = document.getElementsByClassName('vc-user-profile');

            // video-controls-wrapper 요소
            const videoControlsWrapper = document.querySelector('.video-controls-wrapper');
            const toggleMicButton = document.getElementById('toggleMic');
            const toggleVideoButton = document.getElementById('toggleVideo');
            const toggleRemoteAudioButton = document.getElementById('toggleRemoteAudio');
            const remoteVolumeSlider = document.getElementById('remoteVolume');
            const toggleRemoteVideoButton = document.getElementById('toggleRemoteVideo');

            // 마이크 상태
            let micMuted = false;
            // 비디오 상태
            let videoOff = false;
            // 상대방 오디오 상태
            let remoteAudioMuted = false;
            // 상대방 비디오 상태
            let remoteVideoOff = false;

            startRandomChatButton.onclick = function() {
                startRandomChatButton.style.display = 'none';
                loadingMessage.style.display = 'flex';
                videoControlsWrapper.style.display = 'flex';

                for (let i = 0; i < vcUserProfiles.length; i++) {
                    vcUserProfiles[i].style.display = 'none';
                }

                startVideoChat();
            };

            // 마이크 토글
            toggleMicButton.onclick = function() {
                if (localStream) {
                    micMuted = !micMuted;
                    localStream.getAudioTracks().forEach(track => track.enabled = !micMuted);
                    // 아이콘과 텍스트 변경
                    const micIcon = document.getElementById('micIcon');
                    const micText = toggleMicButton.querySelector('span');
                    if (micMuted) {
                        micIcon.innerHTML = `<path d="M12 14a3 3 0 003-3V5a3 3 0 00-6 0v6a3 3 0 003 3z"></path><path d="M19 11a1 1 0 00-1-1h-2a1 1 0 000 2h2a1 1 0 001-1z"></path><line x1="1" y1="1" x2="23" y2="23" stroke="red" stroke-width="2"/>`; // 예: 빨간색 X 표시
                        micText.textContent = '마이크 켜기';
                    } else {
                        micIcon.innerHTML = `<path d="M12 14a3 3 0 003-3V5a3 3 0 00-6 0v6a3 3 0 003 3z"></path><path d="M19 11a1 1 0 00-1-1h-2a1 1 0 000 2h2a1 1 0 001-1z"></path>`;
                        micText.textContent = '마이크 끄기';
                    }
                }
            };

            // 비디오 토글
            toggleVideoButton.onclick = function() {
                if (localStream) {
                    videoOff = !videoOff;
                    localStream.getVideoTracks().forEach(track => track.enabled = !videoOff);
                    // 아이콘과 텍스트 변경
                    const videoIcon = document.getElementById('videoIcon');
                    const videoText = toggleVideoButton.querySelector('span');
                    if (videoOff) {
                        videoIcon.innerHTML = `<path d="M17 10.5V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4.5l4 4v-13l-4 4z"></path><line x1="1" y1="1" x2="23" y2="23" stroke="red" stroke-width="2"/>`; // 예: 빨간색 X 표시
                        videoText.textContent = '카메라 켜기';
                    } else {
                        videoIcon.innerHTML = `<path d="M17 10.5V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4.5l4 4v-13l-4 4z"></path>`;
                        videoText.textContent = '카메라 끄기';
                    }
                }
            };

            // 상대방 소리 토글
            toggleRemoteAudioButton.onclick = function() {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    remoteAudioMuted = !remoteAudioMuted;
                    remoteVideo.muted = remoteAudioMuted;
                    // 아이콘과 텍스트 변경
                    const remoteAudioIcon = document.getElementById('remoteAudioIcon');
                    const remoteAudioText = toggleRemoteAudioButton.querySelector('span');
                    if (remoteAudioMuted) {
                        remoteAudioIcon.innerHTML = `<path d="M3 9v6h4l5 5V4L7 9H3z"></path><line x1="1" y1="1" x2="23" y2="23" stroke="red" stroke-width="2"/>`; // 예: 빨간색 X 표시
                        remoteAudioText.textContent = '상대방 소리 켜기';
                    } else {
                        remoteAudioIcon.innerHTML = `<path d="M3 9v6h4l5 5V4L7 9H3z"></path>`;
                        remoteAudioText.textContent = '상대방 소리 끄기';
                    }
                }
            };

            // 상대방 볼륨 조절
            remoteVolumeSlider.oninput = function() {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    remoteVideo.volume = this.value;
                }
            };

            // 상대방 화면 토글
            toggleRemoteVideoButton.onclick = function() {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    remoteVideoOff = !remoteVideoOff;
                    remoteVideo.style.display = remoteVideoOff ? 'none' : 'block';
                    // 아이콘과 텍스트 변경
                    const remoteVideoIcon = document.getElementById('remoteVideoIcon');
                    const remoteVideoText = toggleRemoteVideoButton.querySelector('span');
                    if (remoteVideoOff) {
                        remoteVideoIcon.innerHTML = `<path d="M17 10.5V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4.5l4 4v-13l-4 4z"></path><line x1="1" y1="1" x2="23" y2="23" stroke="red" stroke-width="2"/>`; // 예: 빨간색 X 표시
                        remoteVideoText.textContent = '상대방 화면 켜기';
                    } else {
                        remoteVideoIcon.innerHTML = `<path d="M17 10.5V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-4.5l4 4v-13l-4 4z"></path>`;
                        remoteVideoText.textContent = '상대방 화면 끄기';
                    }
                }
            };

            disconnectButton.onclick = function() {
                disconnectChat();
            };

            findAnotherButton.onclick = function() {
                disconnectChat();
                resetForNewChat();
                startVideoChat();
                startRandomChatButton.style.display = 'none';
                loadingMessage.style.display = 'flex';
                videoControlsWrapper.style.display = 'flex';

                for (let i = 0; i < vcUserProfiles.length; i++) {
                    vcUserProfiles[i].style.display = 'none';
                }
            };

            function resetForNewChat() {
                chatControlBox.style.display = 'none';
                startRandomChatButton.style.display = 'flex';
            }

            function disconnectChat() {
                if (signalingServer) {
                    signalingServer.close();
                    signalingServer = null;
                }
                cleanupVideoChat();
                resetForNewChat();
            }

            // accessToken을 URL에 포함시키는 함수
            function getSignalingServerUrl(accessToken) {
                const baseUrl = 'wss://1.232.89.187:8443/ws/random-video-chat';
                if (accessToken) {
                    return `${baseUrl}?accessToken=${encodeURIComponent(accessToken)}`;
                }
                return baseUrl;
            }

            function startVideoChat() {
                const localVideo = document.getElementById('localVideo');
                const remoteVideo = document.getElementById('remoteVideo');


                // WebSocket URL 생성
                const signalingServerUrl = getSignalingServerUrl(accessToken);


                if (signalingServer) {
                    signalingServer.close();  // 기존 연결이 있으면 종료
                    signalingServer = null;
                }

                signalingServer = new WebSocket(signalingServerUrl);
                const chatBox = document.getElementById('chatBox');
                const messageInput = document.getElementById('messageInput');
                const sendMessageButton = document.getElementById('sendMessage');

                signalingServer.onopen = () => {
                    console.log("랜덤채팅 대기열에 추가되었습니다.");
                    signalingServer.send(JSON.stringify({ type: 'random'})); // 대기열에 추가 요청 시 사용자 정보 포함
                };

                initializePeerConnection(localVideo, remoteVideo);
                videoControlsWrapper.style.display = 'flex';

                signalingServer.onmessage = message => {
                    const data = JSON.parse(message.data);
                    switch (data.type) {
                        case 'match':
                            setTimeout(() => {
                                alert(data.message);
                                loadingMessage.style.display = 'none';
                                chatControlBox.style.display = 'flex';
                                // 역할 할당 정보 확인
                                role = data.role;
                                if (role === 'offerer') {
                                    createOffer();
                                } else if (role === 'answerer') {
                                    // Offer를 기다림
                                    console.log("Answerer 역할: Offer를 기다립니다.");
                                }
                            }, 2000);
                            break;
                        case 'offer':
                            if (role === 'answerer') {
                                handleOffer(data.offer);
                            }
                            break;
                        case 'answer':
                            if (role === 'offerer') {
                                handleAnswer(data.answer);
                            }
                            break;
                        case 'candidate':
                            handleCandidate(data.candidate);
                            break;
                        case 'chat':
                            chatBox.innerHTML += `<div>상대방: ${data.message}</div>`;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            break;
                        case 'system':  // 추가: 퇴장 메시지 처리
                            chatBox.innerHTML += `<div class="system-message">${data.message}</div>`;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            break;
                        case 'waiting': // 추가: 대기 메시지 처리
                            loadingMessage.style.display = 'flex';
                            chatControlBox.style.display = 'none';
                            break;
                        default:
                            console.log("알 수 없는 메시지 타입: " + data.type);
                    }
                };

                sendMessageButton.onclick = () => {
                    const message = messageInput.value;
                    if (message) {
                        signalingServer.send(JSON.stringify({ type: 'chat', message: message }));
                        chatBox.innerHTML += `<div>나: ${message}</div>`;
                        chatBox.scrollTop = chatBox.scrollHeight;
                        messageInput.value = '';
                    }
                };

                messageInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendMessageButton.click();
                    }
                });
            }

            // function initializePeerConnection(localVideo, remoteVideo) {
            //     // localVideo와 remoteVideo가 정상적으로 전달되었는지 확인
            //     if (!localVideo || !remoteVideo) {
            //         console.error("비디오 요소가 정의되지 않았습니다");
            //         return;
            //     }
            //     navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            //         .then(stream => {
            //             localVideo.srcObject = stream;
            //             localStream = stream;
            //
            //             peerConnection = new RTCPeerConnection(config);
            //             console.log("RTC 연결 생성됨");
            //             // 로컬 비디오 및 오디오 트랙을 추가하여 원격 피어에게 전송
            //             addTracksToPeerConnection(localStream);
            //
            //             // ICE connection state change 이벤트 핸들러 설정
            //             peerConnection.oniceconnectionstatechange = function() {
            //                 console.log("ICE 연결 상태:", peerConnection.iceConnectionState);
            //             };
            //
            //             peerConnection.onicecandidate = event => {
            //                 if (event.candidate) {
            //                     console.log("ICE 후보 발견:", event.candidate);
            //                     signalingServer.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
            //                 }
            //             };
            //
            //             // 상대방의 트랙이 추가되었을 때 (상대방 화면이 들어옴)
            //             peerConnection.ontrack = event => {
            //                 console.log("상대방 트랙 수신:", event);
            //                 if (!remoteStream) {
            //                     remoteStream = new MediaStream();
            //                     remoteVideo.srcObject = remoteStream;
            //                 }
            //                 remoteStream.addTrack(event.track);
            //                 console.log("상대방 화면 표시 시작");
            //             };
            //
            //             return peerConnection.createOffer();
            //         })
            //         .then(offer => {
            //             return peerConnection.setLocalDescription(offer);
            //         })
            //         .then(() => {
            //             signalingServer.send(JSON.stringify({ type: 'offer', offer: peerConnection.localDescription }));
            //         })
            //         .catch(error => {
            //             console.error("startVideoChat 중 오류:", error);
            //         });
            // }

            function initializePeerConnection(localVideo, remoteVideo) {
                if (!localVideo || !remoteVideo) {
                    console.error("비디오 요소가 정의되지 않았습니다");
                    return Promise.reject("비디오 요소 미정의");
                }

                return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        localVideo.srcObject = stream;
                        localStream = stream;

                        peerConnection = new RTCPeerConnection(config);
                        console.log("RTC 연결 생성됨");
                        addTracksToPeerConnection(localStream);

                        peerConnection.oniceconnectionstatechange = function() {
                            console.log("ICE 연결 상태:", peerConnection.iceConnectionState);
                        };

                        peerConnection.onicecandidate = event => {
                            if (event.candidate) {
                                console.log("ICE 후보 발견:", event.candidate);
                                signalingServer.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                            }
                        };

                        peerConnection.ontrack = event => {
                            console.log("상대방 트랙 수신:", event);
                            if (!remoteStream) {
                                remoteStream = new MediaStream();
                                remoteVideo.srcObject = remoteStream;
                            }
                            remoteStream.addTrack(event.track);
                            console.log("상대방 화면 표시 시작");
                        };
                    })
                    .catch(error => {
                        console.error("getUserMedia 중 오류:", error);
                        return Promise.reject(error);
                    });
            }


            function addTracksToPeerConnection(stream) {
                if (!peerConnection) {
                    console.error("PeerConnection이 초기화되지 않았습니다.");
                    return;
                }
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
            }

            function handleOffer(offer) {
                console.log("Offer 수신: ", offer);
                if (!peerConnection || peerConnection.signalingState !== "stable") {
                    console.warn("Offer를 수신할 수 없는 잘못된 상태입니다. 시그널링 상태:", peerConnection.signalingState);
                    return;
                }

                peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => {
                        console.log("Remote Description 설정 완료");
                        return peerConnection.createAnswer();
                    })
                    .then(answer => {
                        console.log("Answer 생성 완료");
                        return peerConnection.setLocalDescription(answer);
                    })
                    .then(() => {
                        console.log("Local Description 설정 완료");
                        signalingServer.send(JSON.stringify({ type: 'answer', answer: peerConnection.localDescription }));
                    })
                    .then(() => {
                        // 대기 중인 ICE 후보 처리
                        pendingCandidates.forEach(candidate => {
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .catch(error => console.error("대기 중인 ICE 후보 처리 중 오류:", error));
                        });
                        pendingCandidates = [];
                    })
                    .catch(error => console.error("Offer 처리 중 오류: ", error));
            }


            function handleAnswer(answer) {
                console.log("Answer 수신: ", answer);
                if (peerConnection.signalingState !== "have-local-offer") {
                    console.warn("잘못된 상태에서 answer가 수신되었습니다.");
                    return;
                }
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                    .catch(error => console.error("Answer 처리 중 오류:", error));
            }

            function handleCandidate(candidate) {
                if (!peerConnection || !peerConnection.remoteDescription) {
                    console.warn("원격 설명이 설정되지 않아 ICE 후보를 대기합니다.");
                    pendingCandidates.push(candidate);
                    return;
                }
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(error => console.error("ICE 후보 처리 중 오류:", error));
            }

            function createOffer() {
                if (!peerConnection) {
                    console.error("PeerConnection이 초기화되지 않았습니다.");
                    return;
                }
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        signalingServer.send(JSON.stringify({ type: 'offer', offer: peerConnection.localDescription }));
                    })
                    .catch(error => {
                        console.error("Offer 생성 중 오류:", error);
                    });
            }


            function cleanupVideoChat() {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                videoControlsWrapper.style.display = 'none';
                const localVideo = document.getElementById('localVideo');
                const remoteVideo = document.getElementById('remoteVideo');
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                remoteStream = null;
                pendingCandidates = [];
                role = null;
            }


        });
    </script>
</body>
</html>